# Conditional Questions Implementation Guide

This document captures the current conditional onboarding questions, the
conditions that control their visibility, and the automated tests that
protect the behaviour.

## Overview

- Conditional logic lives in each question's `shouldShow()` override.
- `QuestionBank` singletons hold the latest answers; the `shouldShow()`
  checks read from those instances (e.g. `AgeQuestion.instance`).
- The four conditional questions below form a safety-first funnel that
  escalates assessments for users with elevated fall or mobility risk.

## Conditional Questions Summary

| Question ID | Prompt | Trigger summary |
| ------------|--------|-----------------|
| `Q4A` | "Have you fallen in the last 12 months?" | Age ≥ fall-risk threshold **or** 12‑minute walk/run distance below risk cutoff |
| `Q4B` | "Do you experience any of the following?" | Prior fall **or** age ≥ fall-risk threshold **or** 12‑minute walk/run distance below risk cutoff |
| `Q6A` | "Are you able to get up from a chair without using your hands?" | Age ≥ fall-risk threshold **or** 12‑minute walk/run distance below risk cutoff **or** bodyweight squat count = 0 |
| `Q6B` | "How long can you stand on one foot?" | Age ≥ fall-risk threshold **or** prior fall **or** 12‑minute walk/run distance below risk cutoff |

Constants:

- `AnswerConstants.fallRiskAge` (currently 65) gates the age-based risk checks.
- `AnswerConstants.cooperAtRiskMiles` (0.36 miles) determines the mobility
  flag for the 12‑minute walk/run question.

## Behaviour Details

### Q4A – Fall History (`q4a_fall_history_question.dart`)

- **Show when** any of the following hold:
  - `AgeQuestion.calculatedAge` ≥ `AnswerConstants.fallRiskAge`.
  - `Q4TwelveMinuteRunQuestion.runPerformanceData.distanceMiles` <
    `AnswerConstants.cooperAtRiskMiles` (i.e. mobility risk).
- **Hide when** both conditions fail (age below threshold *and*
  no mobility flag or missing run data).
- **Usage note:** This question is required; `shouldShow()` is the only gate.

### Q4B – Fall Risk Factors (`q4b_fall_risk_factors_question.dart`)

- **Show when** at least one of the following is true:
  - `Q4AFallHistoryQuestion.fallHistoryAnswer` == `AnswerConstants.yes`.
  - `AgeQuestion.calculatedAge` ≥ `AnswerConstants.fallRiskAge`.
  - `Q4TwelveMinuteRunQuestion.runPerformanceData.distanceMiles` <
    `AnswerConstants.cooperAtRiskMiles`.
- **Hide when** the user is under the age threshold, has no recorded fall,
  and demonstrates adequate mobility (distance ≥ cutoff or no run data yet).
- **Answer model:** multi-select list with `AnswerConstants.none` to capture
  "no risk factors" explicitly.

### Q6A – Chair Stand (`q6a_chair_stand_question.dart`)

- **Show when** any of the following conditions trigger:
  - `AgeQuestion.calculatedAge` ≥ `AnswerConstants.fallRiskAge`.
  - `Q4TwelveMinuteRunQuestion.runPerformanceData.distanceMiles` <
    `AnswerConstants.cooperAtRiskMiles`.
  - `Q6BodyweightSquatsQuestion.squatsCount` (via `QuestionBank.toJson`) == 0.
- **Hide when** the user is below the risk age, has adequate 12‑minute walk
  distance, and reports at least one successful bodyweight squat.
- **Implementation detail:** The squat check reads from the serialized answer
  map generated by `QuestionBank.toJson()`.

### Q6B – Single-Leg Balance (`q6b_balance_test_question.dart`)

- **Show when** any risk factor is present:
  - Age ≥ `AnswerConstants.fallRiskAge`.
  - `Q4AFallHistoryQuestion.fallHistoryAnswer` == `AnswerConstants.yes`.
  - 12‑minute walk/run distance < `AnswerConstants.cooperAtRiskMiles`.
- **Hide when** none of the above triggers are met (i.e. younger user with no
  fall history and adequate mobility performance).

## Automated Tests

Targeted unit tests live in
`ascent/test/onboarding_workflow/conditional_questions_test.dart` and cover the
following scenarios:

- `Q4AFallHistoryQuestion.shouldShow()`
  - Shows at the age threshold.
  - Shows when mobility performance is below the Cooper cutoff.
  - Remains hidden when no risk indicators are present.
- `Q4BFallRiskFactorsQuestion.shouldShow()`
  - Shows when a previous fall is recorded.
  - Shows based on age alone.
  - Shows based on mobility risk.
  - Hides when all risk checks fail.
- `Q6AChairStandQuestion.shouldShow()`
  - Shows via age, mobility, and zero-squat triggers individually.
  - Hides when the user meets the safe criteria.
- `Q6BBalanceTestQuestion.shouldShow()`
  - Shows for age, mobility, and fall-history triggers individually.
  - Hides when no risk triggers apply.

Run the suite with `flutter test ascent/test/onboarding_workflow/conditional_questions_test.dart`
or simply `flutter test` from the repository root.

## Maintenance Tips

- When adding future conditional questions, expose a small helper in the doc
  and mirror it in `conditional_questions_test.dart`.
- Keep tests focused on visibility logic; answer validation should stay in the
  widget/unit responsible for user input.
